# クイズ機能 テストシナリオ

## テスト環境準備

### 前提条件
- ステージング環境: https://quarkus-crud.ouchiserver.aokiapp.com
- 2人以上のユーザーアカウント（ゲスト認証）
- プロフィール情報が入力済み

## シナリオ1: イベント作成からクイズ完了まで（シングルユーザー）

### 1.1 プロフィール作成
```
URL: /me/profile/edit
操作:
1. 表示名を入力（例: 山田 花）
2. 趣味を入力（例: 読書）
3. 好きなアーティストを入力（例: YOASOBI）
4. 学部を選択（例: 工学部）
5. 学年を選択（例: 2年生）
6. 保存

期待結果:
- プロフィールが保存される
- /me/profile にリダイレクト
```

### 1.2 イベント作成
```
URL: /events/new
操作:
1. イベント名を入力
2. 必要情報を入力
3. 作成

期待結果:
- イベントが作成される
- イベントロビーにリダイレクト
- 招待コードが表示される
```

### 1.3 クイズ編集画面へ遷移
```
URL: /events/:eventId
操作:
1. 「自分のクイズを編集」ボタンをクリック

期待結果:
- /events/:eventId/quiz にリダイレクト
- クイズステータスが表示される
- 「クイズを作成」ボタンが表示される
```

### 1.4 間違い選択肢の生成
```
URL: /events/:eventId/quiz/edit
操作:
1. 「名前を自動生成」ボタンをクリック
2. LLMが生成した名前を確認
3. 趣味の間違い選択肢を手動入力（例: サッカー、料理、音楽鑑賞）
4. アーティストの間違い選択肢を手動入力（例: ヨルシカ、米津玄師、あいみょん）
5. 「保存してロビーへ戻る」をクリック

期待結果:
- LLM APIが呼ばれ、2種類の名前が生成される
  - 似ていない名前 × 3
  - とても似ている名前 × 3
- fakeAnswersがEventUserDataに保存される
- イベントロビーにリダイレクト

API呼び出し:
POST /api/llm/fake-names
{
  "inputName": "山田 花",
  "variance": "互いにまったく似ていない名前"
}

PUT /api/events/:eventId/users/:userId
{
  "userData": {
    "fakeAnswers": {
      "username": ["田中 太郎", "鈴木 花子", "佐藤 健"],
      "hobby": ["サッカー", "料理", "音楽鑑賞"],
      "artist": ["ヨルシカ", "米津玄師", "あいみょん"],
      "verySimilarUsername": ["山田 華", "山本 花", "山口 花"]
    },
    "updatedAt": "2026-01-14T11:00:00Z"
  }
}
```

### 1.5 クイズステータス確認
```
URL: /events/:eventId/quiz
操作:
1. ロビーから「自分のクイズを編集」をクリック

期待結果:
- 「クイズの間違いの選択肢が設定されています」と表示
- 「クイズを編集」ボタンが表示される
```

## シナリオ2: 2人目のユーザーがクイズに挑戦

### 2.1 イベント参加
```
URL: /qr/join?code=XXXXX または /events/join
操作:
1. 招待コードを入力/QRコードスキャン
2. 参加

期待結果:
- イベントに参加
- EventAttendeeが作成される
- イベントロビーにリダイレクト
```

### 2.2 自分のクイズ作成
```
URL: /events/:eventId/quiz/edit
操作:
シナリオ1.4と同様

期待結果:
- 自分のfakeAnswersが保存される
```

### 2.3 クイズ挑戦一覧
```
URL: /events/:eventId/quiz/challenges
操作:
1. ロビーから「クイズに挑戦」をクリック

期待結果:
- 他の参加者（ユーザー1）が表示される
- 各参加者に「開始」ボタンが表示される
```

### 2.4 クイズ問題に回答
```
URL: /events/:eventId/quiz/challenge/:targetUserId/1
操作:
1. 参加者のクイズ「開始」ボタンをクリック
2. 問題1「名前は何でしょう？」に回答
3. 正誤確認
4. 「次の問題へ」をクリック
5. 全6問に回答

期待結果:
問題1: 名前は何でしょう？
- 選択肢: [山田 花, 田中 太郎, 鈴木 花子, 佐藤 健] （ランダム順）
- 正解: 山田 花

問題2: 学部は何でしょう？
- 選択肢: [工学部, 理学部, 文学部, 経済学部] （ランダム順）
- 正解: 工学部

問題3: 学年は何でしょう？
- 選択肢: [2年生, 1年生, 3年生, 4年生] （ランダム順）
- 正解: 2年生

問題4: 趣味は何でしょう？
- 選択肢: [読書, サッカー, 料理, 音楽鑑賞] （ランダム順）
- 正解: 読書

問題5: 改めて、名前は何でしょう？
- 選択肢: [山田 花, 山田 華, 山本 花, 山口 花] （ランダム順）
- 正解: 山田 花

問題6: 好きなアーティストは誰でしょう？
- 選択肢: [YOASOBI, ヨルシカ, 米津玄師, あいみょん] （ランダム順）
- 正解: YOASOBI

各問題後:
- 即座に正誤が表示される
- スコアがセッションストレージに保存される
```

### 2.5 結果表示
```
URL: /events/:eventId/quiz/challenge/:targetUserId/result
操作:
1. 最後の問題に回答後、自動遷移

期待結果:
- 正解率が円グラフで表示される（例: 83%）
- スコアが表示される（例: 5/6 問正解）
- パフォーマンス評価が表示される
  - 100%: 完璧です！
  - 80-99%: 素晴らしい！
  - 60-79%: 良くできました！
  - 40-59%: もう少し！
  - 0-39%: 次回頑張りましょう！
- 「他のクイズに挑戦」ボタン
- 「ロビーへ戻る」ボタン
```

## シナリオ3: エラーハンドリング

### 3.1 プロフィール未作成でクイズ編集
```
URL: /events/:eventId/quiz/edit
前提: プロフィールが未作成または情報不足

期待結果:
- 「プロフィール情報不足」警告が表示される
- 「プロフィールを編集」ボタンが表示される
- 「ロビーへ戻る」ボタンが表示される
```

### 3.2 fake Answers未作成でクイズ挑戦
```
URL: /events/:eventId/quiz/challenge/:targetUserId/1
前提: 対象ユーザーがfakeAnswersを未作成

期待結果:
- 「クイズが見つかりません」警告が表示される
- 「このユーザーはまだクイズを作成していません」メッセージ
- 「一覧へ戻る」ボタン
```

### 3.3 LLM API呼び出し失敗
```
URL: /events/:eventId/quiz/edit
操作:
1. 「名前を自動生成」ボタンをクリック
2. API呼び出しが失敗（ネットワークエラー等）

期待結果:
- コンソールにエラーログ
- UIは引き続き操作可能
- 手動入力にフォールバック可能
```

### 3.4 クイズ保存失敗
```
URL: /events/:eventId/quiz/edit
操作:
1. 「保存してロビーへ戻る」をクリック
2. API呼び出しが失敗

期待結果:
- 赤いAlertが表示される
- 「クイズの保存に失敗しました。もう一度お試しください。」
- Alertは閉じることができる
- ページに留まり、再保存可能
```

## シナリオ4: セッションストレージ管理

### 4.1 クイズ途中でブラウザ更新
```
URL: /events/:eventId/quiz/challenge/:targetUserId/3
操作:
1. 問題3まで回答
2. F5でブラウザ更新

期待結果:
- 問題3が再表示される
- これまでのスコアは保持される（セッションストレージ）
```

### 4.2 別のクイズに挑戦
```
URL: /events/:eventId/quiz/challenges
操作:
1. ユーザーAのクイズに挑戦（スコア: 4/6）
2. 結果画面から「他のクイズに挑戦」
3. ユーザーBのクイズを選択

期待結果:
- ユーザーBのクイズが新規スタート
- ユーザーAのスコアはクリアされる
- セッションストレージキー:
  - quiz_${eventId}_${userA}_score: 削除
  - quiz_${eventId}_${userA}_answers: 削除
  - quiz_${eventId}_${userB}_score: 0
  - quiz_${eventId}_${userB}_answers: []
```

## 性能テスト

### レスポンスタイム目標
- LLM API呼び出し: < 5秒
- fakeAnswers保存: < 1秒
- クイズ生成（クライアント側）: < 100ms
- 問題表示: < 500ms

## アクセシビリティチェック

### キーボード操作
- Tabキーで全ての入力フィールドとボタンにフォーカス可能
- Enterキーでボタン押下可能
- Escキーでモーダル/Alert閉じる可能

### スクリーンリーダー
- Alertにrole="alert"が設定されている
- ボタンに適切なaria-labelが設定されている
- フォームフィールドにlabelが関連付けられている
